@* Areas/AccountPermissionManagement/Views/FarmerManagement/Index.cshtml *@
@model ADAMS.Areas.AccountPermissionManagement.ViewModels.FarmerManagement.FarmerListViewModel
@{
    ViewData["Title"] = "養殖戶管理";
}

<div class="container-fluid p-4" style="background-color: #FFFACD;">
    <!-- 標題列 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">@ViewData["Title"]</h4>
        <a asp-action="Create" class="btn btn-primary">
            新增養殖戶
        </a>
    </div>

    <!-- 成功/錯誤訊息 -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- 篩選列 -->
    <div class="card mb-3">
        <div class="card-body py-2">
            <form asp-action="Index" method="get" class="row g-2 align-items-center">
                <div class="col-auto">
                    <label class="col-form-label">啟用狀態：</label>
                </div>
                <div class="col-auto">
                    <select name="statusFilter" class="form-select form-select-sm" style="width: 150px;">
                        <option value="">全部</option>
                        <option value="啟用" selected="@(Model.StatusFilter == "啟用")">啟用</option>
                        <option value="停用" selected="@(Model.StatusFilter == "停用")">停用</option>
                    </select>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm btn-primary">搜尋</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 資料表格 -->
    <div class="card">
        <div class="card-body p-0">
            @if (Model.Farmers.Any())
            {
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50px;">No</th>
                                <th>養殖戶編號</th>
                                <th>名稱</th>
                                <th>負責人</th>
                                <th>負責人電話</th>
                                <th>負責人信箱</th>
                                <th>備註</th>
                                <th style="width: 100px;">功能</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var (farmer, index) in Model.Farmers.Select((f, i) => (f, i + 1 + (Model.CurrentPage - 1) * Model.PageSize)))
                            {
                                <tr>
                                    <td class="text-center">@index</td>
                                    <td>@farmer.TenantNum</td>
                                    <td>@farmer.TenantName</td>
                                    <td>@(farmer.ResponName ?? "-")</td>
                                    <td>@(farmer.ResponPhone ?? "-")</td>
                                    <td>@(farmer.ResponEmail ?? "-")</td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(farmer.Remark))
                                        {
                                            <button type="button" 
                                                    class="btn btn-info btn-sm" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#remarkModal"
                                                    data-remark="@farmer.Remark"
                                                    data-name="@farmer.TenantName">
                                                查看
                                            </button>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a asp-action="Edit" 
                                               asp-route-id="@farmer.SN" 
                                               class="btn btn-warning btn-sm"
                                               title="修改">
                                                修改
                                            </a>
                                            @if (farmer.IsEnable)
                                            {
                                                <button type="button" 
                                                        class="btn btn-danger btn-sm toggle-status-btn" 
                                                        data-id="@farmer.SN"
                                                        data-enable="false"
                                                        data-name="@farmer.TenantName"
                                                        title="停用">
                                                    停用
                                                </button>
                                            }
                                            else
                                            {
                                                <button type="button" 
                                                        class="btn btn-success btn-sm toggle-status-btn" 
                                                        data-id="@farmer.SN"
                                                        data-enable="true"
                                                        data-name="@farmer.TenantName"
                                                        title="啟用">
                                                    啟用
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- 分頁 -->
                @if (Model.TotalPages >= 1)
                {
                 <div class="card-footer bg-warning-subtle">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">

                    <div><small class="text-muted">資料總筆數：@Model.TotalCount</small></div>

                    <form method="get" asp-action="Index" class="d-flex align-items-center gap-2">
                        <input type="hidden" name="statusFilter" value="@Model.StatusFilter" />

                        <label class="form-label mb-0">每頁：</label>
                        <select name="pageSize" class="form-select form-select-sm" onchange="this.form.submit()">
                        @foreach (var size in new[] {2,5,10,15,20}) {
                            if (size == Model.PageSize) { <option value="@size" selected>@size</option> }
                            else                        { <option value="@size">@size</option> }
                        }
                        </select>

                        @* 上一頁：超連結 *@
                        <a class="btn btn-sm btn-outline-secondary @(Model.CurrentPage==1 ? "disabled" : "")"
                            asp-action="Index"
                            asp-route-page="@(Math.Max(1, Model.CurrentPage-1))"
                            asp-route-pageSize="@Model.PageSize"
                            asp-route-statusFilter="@Model.StatusFilter">上一頁</a>

                        @* 跳頁下拉（唯一帶 name="page" 的欄位） *@
                        <select name="page" class="form-select form-select-sm" onchange="this.form.submit()">
                        @for (int i=1; i<=Model.TotalPages; i++) {
                            if (i == Model.CurrentPage) { <option value="@i" selected>@i</option> }
                            else                        { <option value="@i">@i</option> }
                        }
                        </select>

                        @* 下一頁：超連結 *@
                        <a class="btn btn-sm btn-outline-secondary @(Model.CurrentPage==Model.TotalPages ? "disabled" : "")"
                            asp-action="Index"
                            asp-route-page="@(Math.Min(Model.TotalPages, Model.CurrentPage+1))"
                            asp-route-pageSize="@Model.PageSize"
                            asp-route-statusFilter="@Model.StatusFilter">下一頁</a>
                    </form>
                    </div>
                </div>
                }
            }
            else
            {
                <div class="text-center py-5">
                    <p class="text-muted">尚無養殖戶資料</p>
                    <a asp-action="Create" class="btn btn-primary">新增養殖戶</a>
                </div>
            }
        </div>
    </div>
</div>

<!-- 備註彈出視窗 Modal -->
<div class="modal fade" id="remarkModal" tabindex="-1" aria-labelledby="remarkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="remarkModalLabel">
                    <i class="bi bi-pencil-square"></i> 備註內容
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <strong>養殖戶：</strong>
                    <span id="remarkFarmerName"></span>
                </div>
                <hr />
                <div style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;" id="remarkContent">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // 備註彈出視窗
            $('#remarkModal').on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);
                var remark = button.data('remark');
                var name = button.data('name');
                
                var modal = $(this);
                modal.find('#remarkFarmerName').text(name);
                modal.find('#remarkContent').text(remark);
            });
            
            // 啟用/停用按鈕
            $('.toggle-status-btn').on('click', function() {
                const id = $(this).data('id');
                const enable = $(this).data('enable');
                const name = $(this).data('name');
                const action = enable ? '啟用' : '停用';
                
                if (confirm(`確定要${action}養殖戶「${name}」嗎？`)) {
                    toggleStatus(id, enable);
                }
            });

            function toggleStatus(id, isEnable) {
                $.ajax({
                    url: '@Url.Action("ToggleStatus", "FarmerManagement", new { area = "AccountPermissionManagement" })',
                    type: 'POST',
                    data: {
                        id: id,
                        isEnable: isEnable,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            location.reload();
                        } else {
                            alert('錯誤：' + response.message);
                        }
                    },
                    error: function() {
                        alert('操作失敗，請稍後再試');
                    }
                });
            }
        });
    </script>
}

<style>
    .table-responsive {
        overflow-x: auto;
    }
    
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    .btn-group-sm > .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>