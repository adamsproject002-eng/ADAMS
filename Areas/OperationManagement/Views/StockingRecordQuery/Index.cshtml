@{
    ViewData["Title"] = "放苗作業紀錄";
}

<div class="container-fluid p-4" style="background-color: #FFFACD;">
    <!-- 標題列 -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">@ViewData["Title"]</h4>
        <a href="/OperationManagement/StockingRecordQuery/Create" class="btn btn-primary">新增放苗作業紀錄</a>
    </div>

    <!-- 成功/錯誤訊息 -->
    <div id="AlertContainer"></div>

    <!-- 篩選列 -->
    <div class="card mb-3">
        <div class="col-auto d-flex align-items-center gap-3">
            <form id="FilterForm" class="row g-2 align-items-center gap-4">
                <!-- 場區 -->
                <div class="col-auto">
                    <label class="col-form-label">場區:</label>
                </div>
                <div class="col-auto">
                    <select id="AreaSelect" class="form-select form-select-sm" style="width: 150px;">
                        <!-- 選項將由 JS 動態生成 -->
                    </select>
                </div>
                <!-- 放苗日期 -->
                <div class="col-auto">
                    <div class="row g-2 align-items-center">
                        <div class="col-auto">
                            <label class="col-form-label mb-0">放苗日期:</label>
                        </div>
                        <div class="col-auto">
                            <input type="date" id="StartDate" class="form-control form-control-sm" />
                        </div>
                        <div class="col-auto">~</div>
                        <div class="col-auto">
                            <input type="date" id="EndDate" class="form-control form-control-sm" />
                        </div>
                    </div>
                </div>
                <div class="col-auto">
                    <button type="submit" class="btn btn-sm btn-primary">搜尋</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 資料表格 -->
    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="FryTable" class="table table-bordered table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50px;">No</th>
                            <th>放養碼</th>
                            <th>放苗日期</th>
                            <th>尾數(pcs)</th>
                            <th>苗齡(克/尾)</th>
                            <th>管理員</th>
                            <th>種類</th>
                            <th>放養密度</th>
                            <th>功能</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS 動態生成 -->
                    </tbody>
                </table>
            </div>
            <!-- 分頁 -->
            <div
                class="card-footer bg-warning-subtle d-flex justify-content-between align-items-center flex-nowrap gap-2">
                <div style="white-space: nowrap;">資料總筆數：<span id="TotalCount">0</span></div>
                <div class="d-flex align-items-center gap-3" style="white-space: nowrap;">
                    <div class="d-flex align-items-center gap-1">
                        <label class="mb-0">每頁：</label>
                        <select id="PageSizeSelect" class="form-select form-select-sm" style="width: auto;">
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center gap-1">
                        <label class="mb-0">頁碼：</label>
                        <select id="PageSelect" class="form-select form-select-sm" style="width: auto;"></select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 備註彈出視窗 Modal -->
<div class="modal fade" id="RemarkModal" tabindex="-1" aria-labelledby="RemarkModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="RemarkModalLabel">
                    <i class="bi bi-pencil-square"></i> 備註內容
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <strong>養殖戶：</strong>
                    <span id="RemarkFarmerName"></span>
                </div>
                <hr />
                <div style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;" id="RemarkContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let CurrentPage = 1;
        const PageSizeSelect = document.getElementById('PageSizeSelect');
        let PageSize = parseInt(PageSizeSelect.options[0].value);
        let AllRecords = [];
        const TenantSN = @ViewBag.TenantSN ?? 1;

        // 抓資料（依照篩選條件）
        async function LoadFryRecords() {
            const AreaSelect = document.getElementById('AreaSelect');
            const CurrentArea = AreaSelect.value;
            const StartDate = document.getElementById('StartDate').value;
            const EndDate = document.getElementById('EndDate').value;

            const Url = `/OperationManagement/StockingRecordQuery/GetPagedListJson?tenantSN=${TenantSN}&areaName=${CurrentArea}&startDate=${StartDate}&endDate=${EndDate}`;
            const Response = await fetch(Url);
            const Data = await Response.json();

            AllRecords = Data.Records || [];

            // 動態生成場區下拉選單
            AreaSelect.innerHTML = '<option value="">全部</option>';
            Data.AreaNames.forEach(area => {
                const Option = document.createElement('option');
                Option.value = area;
                Option.textContent = area;
                AreaSelect.appendChild(Option);
            });

            if (CurrentArea) {
                AreaSelect.value = CurrentArea;
            }

            CurrentPage = 1;
            RenderTablePage();
            RenderPagination(AllRecords.length);
        }

        // 渲染指定頁面的表格
        function RenderTablePage() {
            const TBody = document.querySelector('#FryTable tbody');
            TBody.innerHTML = '';

            if (!AllRecords || AllRecords.length === 0) {
                TBody.innerHTML = `<tr><td colspan="9" class="text-center">尚無放苗作業紀錄</td></tr>`;
                return;
            }

            const Start = (CurrentPage - 1) * PageSize;
            const End = Start + PageSize;
            const PageRecords = AllRecords.slice(Start, End);

            PageRecords.forEach((Record, Index) => {
                const No = Start + Index + 1;
                const Tr = document.createElement('tr');
                Tr.innerHTML = `
                    <td class="text-center">${No}</td>
                    <td>${Record.FarmingCode}</td>
                    <td>${Record.FarmingDate ? new Date(Record.FarmingDate).toLocaleDateString() : ''}</td>
                    <td>${Record.FarmingPCS}</td>
                    <td>${Record.FryAge}</td>
                    <td>${Record.ManageAccount}</td>
                    <td>${Record.FryType ?? ''}</td>
                    <td>${Record.FarmingDensity}</td>
                    <td class="text-center">
                        <div class="d-flex justify-content-center gap-2">
                            <a href="/OperationManagement/StockingRecordQuery/Edit/${Record.FryRecordSN}" class="btn btn-warning btn-sm">修改</a>
                        
                            <button type="button" class="btn btn-danger btn-sm" onclick="DeleteFryRecord(${Record.FryRecordSN})">刪除</button>
                        </div>
                    </td>
                `;
                TBody.appendChild(Tr);
            });

            document.getElementById('TotalCount').textContent = AllRecords.length;
        }
        // 渲染分頁下拉選單
        function RenderPagination(TotalCount) {
            const PageSelect = document.getElementById('PageSelect');
            PageSelect.innerHTML = '';

            const TotalPages = Math.ceil(TotalCount / PageSize);
            for (let i = 1; i <= TotalPages; i++) {
                PageSelect.innerHTML += `<option value="${i}" ${i === CurrentPage ? 'selected' : ''}>${i}</option>`;
            }
        }
        // ==================== 新增：刪除功能 ====================
        function DeleteFryRecord(id) {
            // 1. 跳出確認視窗
            if (!confirm('確定要刪除這筆放苗紀錄嗎？\n(此動作無法復原)')) {
                return; // 如果按取消，就結束
            }

            // 2. 發送 API 請求
            fetch('/OperationManagement/StockingRecordQuery/DisableJson', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id }) // 傳送 ID
            })
                .then(res => res.json())
                .then(res => {
                    if (res.success) {
                        alert(res.message);
                        // 3. 刪除成功後，重新載入資料
                        LoadFryRecords();
                    } else {
                        alert(res.message);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("發生錯誤，請稍後再試");
                });
        }
        // 篩選事件
        document.getElementById('FilterForm').addEventListener('submit', function (e) {
            e.preventDefault();
            LoadFryRecords();
        });

        // 分頁下拉事件
        document.getElementById('PageSelect').addEventListener('change', function () {
            CurrentPage = parseInt(this.value);
            RenderTablePage();
        });

        // 每頁筆數下拉事件
        document.getElementById('PageSizeSelect').addEventListener('change', function () {
            PageSize = parseInt(this.value);
            CurrentPage = 1;
            RenderTablePage();
            RenderPagination(AllRecords.length);
        });

        // 初始化
        document.addEventListener('DOMContentLoaded', function () {
            LoadFryRecords();
        });
    </script>
}