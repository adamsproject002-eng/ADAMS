@{
    ViewData["Title"] = "修改放苗作業紀錄";
    // 把後端抓到的資料轉成 JSON 字串，方便 JS 使用
    var editDataJson = Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.EditData);
}

<div class="container p-4" style="background-color: #FFFACD;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="mb-0">@ViewData["Title"]</h4>
    </div>

    <form id="EditForm" class="row g-3">
        <input type="hidden" id="FryRecordSN" name="FryRecordSN" />
        <input type="hidden" name="TenantSN" value="@ViewBag.TenantSN" />
        <input type="hidden" id="FarmingNum" />

        <div class="col-md-6">
            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">場區 <span class="text-danger">*</span>：</label>
                <div class="col-sm-6">
                    <select id="AreaSelect" class="form-select form-select-sm" required>
                        <option value="">請選擇</option>
                    </select>
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">池號 <span class="text-danger">*</span>：</label>
                <div class="col-sm-6">
                    <select id="PondSelect" class="form-select form-select-sm" required>
                        <option value="">請先選擇場區</option>
                    </select>
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">放養碼：</label>
                <div class="col-sm-6">
                    <input type="text" id="FarmingCode" class="form-control form-control-sm bg-secondary-subtle" readonly />
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">魚苗資料 <span class="text-danger">*</span>：</label>
                <div class="col-sm-6">
                    <select id="FryNameSelect" class="form-select form-select-sm" required>
                        <option value="">請選擇</option>
                        @foreach (dynamic item in ViewBag.FrySNDropList)
                        {
                            <option value="@item.FrySN"
                                    data-fvname="@item.FVName"
                                    data-supplier="@item.SupplierName">
                                @item.FryName
                            </option>
                        }
                    </select>
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">種類：</label>
                <div class="col-sm-6">
                    <input id="FVName" class="form-control form-control-sm bg-light" readonly />
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">供應商：</label>
                <div class="col-sm-6">
                    <input id="SupplierName" class="form-control form-control-sm bg-light" readonly />
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">尾數 (pcs) <span class="text-danger">*</span>：</label>
                <div class="col-sm-6">
                    <input type="number" id="FarmingPCS" class="form-control form-control-sm" min="1" required />
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">苗齡 (克/尾) <span class="text-danger">*</span>：</label>
                <div class="col-sm-6">
                    <input type="number" id="FryAge" class="form-control form-control-sm" step="0.01" required />
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">面積 (m²)：</label>
                <div class="col-sm-6">
                    <input type="number" id="PondArea" class="form-control form-control-sm" step="0.01" min="0" />
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">放養密度：</label>
                <div class="col-sm-6">
                    <input type="number" id="FarmingDensity" class="form-control form-control-sm bg-light" readonly />
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">放苗日期 <span class="text-danger">*</span>：</label>
                <div class="col-sm-6">
                    <input type="date" id="FarmingDate" class="form-control form-control-sm" required />
                </div>
            </div>

            <div class="mb-3 row align-items-center">
                <label class="col-sm-4 col-form-label text-end">管理員 <span class="text-danger">*</span>：</label>
                <div class="col-sm-6">
                    <select id="ManageAccountSelect" class="form-select form-select-sm" required>
                        <option value="">請選擇</option>
                        @foreach (var acc in ViewBag.ManageAccountList)
                        {
                            <option value="@acc">@acc</option>
                        }
                    </select>
                </div>
            </div>
        </div>

        <div class="col-12">
            <label class="form-label">備註：</label>
            <textarea id="Remark" class="form-control" rows="3"></textarea>
        </div>

        <div class="col-12 text-center mt-4">
            <button type="submit" class="btn btn-primary px-5 me-3">儲存修改</button>
            <a href="/OperationManagement/StockingRecordQuery/Index" class="btn btn-secondary px-5">取消</a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // 1. 取得後端資料
        const AreaPondMap = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(ViewBag.AreaPondDropList));
        const EditData = @Html.Raw(editDataJson);

        // DOM 元素
        const AreaSelect = document.getElementById('AreaSelect');
        const PondSelect = document.getElementById('PondSelect');
        const FryNameSelect = document.getElementById('FryNameSelect');
        const FarmingPCS = document.getElementById('FarmingPCS');
        const PondAreaInput = document.getElementById('PondArea');
        const FarmingDensity = document.getElementById('FarmingDensity');
        const FVName = document.getElementById('FVName');
        const SupplierName = document.getElementById('SupplierName');

        document.addEventListener('DOMContentLoaded', function () {
            InitDropdowns();
            FillData();
            BindEvents();
        });

        // 初始化場區下拉
        function InitDropdowns() {
            for (const area in AreaPondMap) {
                const option = document.createElement('option');
                option.value = area;
                option.textContent = area;
                AreaSelect.appendChild(option);
            }
        }

        // 回填資料
        function FillData() {
            if (!EditData) return;

            document.getElementById('FryRecordSN').value = EditData.FryRecordSN;

            // 1. 設定場區與池號
            AreaSelect.value = EditData.AreaName;
            UpdatePondOptions(EditData.AreaName); // 先產生池號選項
            PondSelect.value = EditData.PondSN;   // 再選取值

            // 2. 一般欄位
            document.getElementById('FarmingCode').value = EditData.FarmingCode;
            document.getElementById('FarmingNum').value = EditData.FarmingNum;
            document.getElementById('FarmingDate').value = EditData.FarmingDate;
            document.getElementById('FarmingPCS').value = EditData.FarmingPCS;
            document.getElementById('FryAge').value = EditData.FryAge;
            document.getElementById('Remark').value = EditData.Remark || '';
            document.getElementById('ManageAccountSelect').value = EditData.ManageAccount;
            
            // 3. 面積與密度
            PondAreaInput.value = EditData.PondArea;
            // 這裡直接觸發一次計算，確保顯示一致
            CalculateDensity(); 

            // 4. 魚苗連動
            FryNameSelect.value = EditData.FrySN;
            UpdateFryInfo(); 
        }

        // 場區變更 -> 更新池號
        AreaSelect.addEventListener('change', function() {
            UpdatePondOptions(this.value);
        });

        function UpdatePondOptions(areaName) {
            PondSelect.innerHTML = '<option value="">請選擇</option>';
            if (AreaPondMap[areaName]) {
                AreaPondMap[areaName].forEach(pondSN => {
                    const option = document.createElement('option');
                    option.value = pondSN;
                    option.textContent = pondSN; 
                    PondSelect.appendChild(option);
                });
            }
        }

        // 魚苗變更 -> 更新種類/供應商
        FryNameSelect.addEventListener('change', UpdateFryInfo);

        function UpdateFryInfo() {
            const selected = FryNameSelect.options[FryNameSelect.selectedIndex];
            FVName.value = selected.getAttribute('data-fvname') || '';
            SupplierName.value = selected.getAttribute('data-supplier') || '';
        }

        // 計算密度事件
        function BindEvents() {
            FarmingPCS.addEventListener('input', CalculateDensity);
            PondAreaInput.addEventListener('input', CalculateDensity);
        }

        function CalculateDensity() {
            const pcs = parseFloat(FarmingPCS.value) || 0;
            const area = parseFloat(PondAreaInput.value) || 0;
            
            if (area > 0 && pcs > 0) {
                // 假設公式：尾數 / 面積
                const density = (pcs / area).toFixed(2); 
                FarmingDensity.value = density;
            } else {
                FarmingDensity.value = '';
            }
        }

        // 送出表單
        document.getElementById('EditForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const model = {
                FryRecordSN: Number(document.getElementById('FryRecordSN').value),
                TenantSN: Number(document.querySelector('[name="TenantSN"]').value),
                PondSN: Number(PondSelect.value),
                FarmingCode: document.getElementById('FarmingCode').value,
                FarmingNum: Number(document.getElementById('FarmingNum').value),
                FarmingDate: document.getElementById('FarmingDate').value,
                FarmingPCS: Number(FarmingPCS.value),
                FryAge: Number(document.getElementById('FryAge').value),
                PondArea: Number(PondAreaInput.value),
                FarmingDensity: Number(FarmingDensity.value),
                Remark: document.getElementById('Remark').value,
                FrySN: Number(FryNameSelect.value),
                ManagerAccount: document.getElementById('ManageAccountSelect').value,
                ModifyUser: "@ViewBag.ModifyUser"
            };

            fetch('/OperationManagement/StockingRecordQuery/UpdateJson', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(model)
            })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    alert(res.message);
                    window.location.href = '/OperationManagement/StockingRecordQuery/Index';
                } else {
                    alert(res.message);
                }
            })
            .catch(err => {
                console.error(err);
                alert("發生錯誤");
            });
        });
    </script>
}